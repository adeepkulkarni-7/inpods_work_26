<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inpods Curriculum Mapping V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 30px;
            line-height: 1.7;
            font-size: 22px;
            zoom: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        h1 {
            color: #1e293b;
            font-size: 32px;
        }

        .version-badge {
            background: #00a8cc;
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 35px;
            font-size: 18px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        .main-layout.no-sidebar {
            grid-template-columns: 1fr;
        }

        /* Sidebar / Library */
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .library-list {
            list-style: none;
        }

        .library-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #e2e8f0;
        }

        .library-item:hover {
            background: #f1f5f9;
        }

        .library-item.active {
            background: #e0f2fe;
            border-color: #00a8cc;
        }

        .library-item-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
        }

        .library-item-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .library-item-mode {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .library-item-mode.mode-a { background: #e0f7fa; color: #006064; }
        .library-item-mode.mode-b { background: #e8f5e9; color: #2e7d32; }

        .library-empty {
            text-align: center;
            padding: 30px 10px;
            color: #94a3b8;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        /* Mode Selection Cards */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 35px;
        }

        .mode-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .mode-card.active {
            border-color: #00a8cc;
        }

        .mode-card.mode-a { border-top: 4px solid #00a8cc; }
        .mode-card.mode-b { border-top: 4px solid #00d4aa; }
        .mode-card.mode-c { border-top: 4px solid #ffa600; }

        .mode-icon {
            font-size: 56px;
            margin-bottom: 18px;
        }

        .mode-card h3 {
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 24px;
        }

        .mode-card p {
            color: #64748b;
            font-size: 16px;
        }

        .mode-label {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .mode-a .mode-label { background: #e0f7fa; color: #006064; }
        .mode-b .mode-label { background: #e8f5e9; color: #2e7d32; }
        .mode-c .mode-label { background: #fff3e0; color: #e65100; }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 10px;
            color: #475569;
            font-size: 16px;
        }

        input[type="file"],
        input[type="text"],
        select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="file"] {
            padding: 12px;
        }

        button {
            background: #00a8cc;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #007a99;
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        button.success {
            background: #10b981;
        }

        button.success:hover {
            background: #059669;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        button.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
            display: block;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            display: block;
        }

        .recommendations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }

        .recommendations-table th,
        .recommendations-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .recommendations-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }

        .recommendations-table td {
            font-size: 15px;
        }

        /* V2: Full question text display */
        .question-text {
            max-width: 450px;
            font-size: 15px;
            color: #334155;
        }

        .question-text-full {
            display: block;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Definition column styling */
        .definition-text {
            max-width: 300px;
            font-size: 14px;
            color: #64748b;
            font-style: italic;
        }

        .confidence-badge, .rating-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .confidence-high, .rating-correct {
            background: #d1fae5;
            color: #065f46;
        }

        .confidence-medium, .rating-partial {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low, .rating-incorrect {
            background: #fee2e2;
            color: #991b1b;
        }

        .justification {
            font-size: 13px;
            color: #64748b;
            max-width: 300px;
        }

        .hidden {
            display: none !important;
        }

        /* File Overview Section */
        .overview-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .overview-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .overview-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .overview-stat {
            background: white;
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .overview-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #00a8cc;
        }

        .overview-stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
        }

        .curriculum-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .curriculum-item {
            padding: 12px 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #00a8cc;
        }

        .curriculum-item.competency { border-left-color: #00a8cc; }
        .curriculum-item.objective { border-left-color: #00d4aa; }
        .curriculum-item.skill { border-left-color: #ffa600; }
        .curriculum-item.topic { border-left-color: #9333ea; }
        .curriculum-item.nmc { border-left-color: #ef4444; }
        .curriculum-item.blooms { border-left-color: #3b82f6; }
        .curriculum-item.complexity { border-left-color: #f59e0b; }

        .curriculum-id {
            font-weight: 700;
            color: #1e293b;
            margin-right: 10px;
        }

        .curriculum-desc {
            color: #475569;
            font-size: 14px;
        }

        .curriculum-type-header {
            font-weight: 600;
            color: #1e293b;
            margin: 15px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .curriculum-type-header:first-child {
            margin-top: 0;
        }

        .curriculum-count {
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: #64748b;
        }

        .sample-questions {
            margin-top: 15px;
        }

        .sample-question {
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #64748b;
        }

        .sample-question-num {
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .sample-question-text {
            color: #334155;
            font-size: 13px;
        }

        .selection-info {
            padding: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* V2.1: Multi-select dimension checkboxes */
        .dimension-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .dimension-checkboxes label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            margin-bottom: 0;
        }

        .dimension-checkboxes label:hover {
            border-color: #00a8cc;
            background: #f0f9ff;
        }

        .dimension-checkboxes input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .dimension-checkboxes input[type="checkbox"]:checked + .dim-label {
            color: #00a8cc;
            font-weight: 600;
        }

        .dim-label {
            font-size: 14px;
            color: #475569;
        }

        .dim-code {
            font-size: 11px;
            color: #94a3b8;
            margin-left: auto;
        }

        .dimension-checkboxes label.selected {
            border-color: #00a8cc;
            background: #e0f7fa;
        }

        .dimension-validation-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .dimension-validation-error.show {
            display: block;
        }

        #loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #00a8cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Insights/Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-container img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .chart-container.full-width {
            grid-column: span 2;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
        }

        .back-btn {
            margin-bottom: 20px;
        }

        /* Coverage Table Styling */
        .coverage-table-section {
            margin-top: 30px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
        }

        .coverage-table-section h4 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .coverage-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        .coverage-table th,
        .coverage-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .coverage-table th {
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }

        .coverage-table td {
            font-size: 14px;
        }

        .coverage-table tr:hover {
            background: #f1f5f9;
        }

        .coverage-table .code-cell {
            font-weight: 700;
            color: #00a8cc;
        }

        .coverage-table .definition-cell {
            color: #64748b;
            max-width: 400px;
        }

        .coverage-table .count-cell {
            font-weight: 600;
            text-align: center;
        }

        .coverage-table .percentage-cell {
            text-align: center;
        }

        .coverage-table .gap-row {
            background: #fee2e2;
        }

        .coverage-table .low-row {
            background: #fef3c7;
        }

        .percentage-bar {
            display: inline-block;
            height: 8px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .percentage-bar.high { background: #10b981; }
        .percentage-bar.medium { background: #f59e0b; }
        .percentage-bar.low { background: #ef4444; }

        /* Token Usage Display */
        .token-usage {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .token-usage-title {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 15px;
            border-left: 1px solid #475569;
        }

        .token-stat:first-of-type {
            border-left: none;
        }

        .token-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #00d4aa;
        }

        .token-stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .token-stat.total .token-stat-value {
            color: #ffa600;
        }

        .token-stat.api-calls .token-stat-value {
            color: #00a8cc;
        }

        /* Rating summary */
        .rating-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .rating-stat {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .rating-stat.correct { background: #d1fae5; }
        .rating-stat.partial { background: #fef3c7; }
        .rating-stat.incorrect { background: #fee2e2; }

        /* Save Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Table wrapper for scrolling */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: relative;
                top: 0;
            }
            .mode-selection {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-container.full-width {
                grid-column: span 1;
            }
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Task Panel - Fixed bottom-right */
        .task-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 360px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
        }

        .task-panel.collapsed .task-panel-body {
            max-height: 0;
            padding: 0;
        }

        .task-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            cursor: pointer;
        }

        .task-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .task-icon {
            font-size: 16px;
        }

        .task-panel.has-active .task-icon {
            animation: spin 2s linear infinite;
        }

        .task-count {
            background: #00a8cc;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .task-count.zero {
            background: #64748b;
        }

        .task-panel-body {
            max-height: 350px;
            overflow-y: auto;
            padding: 12px;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #64748b;
        }

        .task-item.running {
            border-left-color: #00a8cc;
            background: #e0f7fa;
        }

        .task-item.completed {
            border-left-color: #10b981;
            background: #d1fae5;
        }

        .task-item.failed {
            border-left-color: #ef4444;
            background: #fee2e2;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .task-item-type {
            font-weight: 600;
            font-size: 13px;
        }

        .task-item-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: #64748b;
            color: white;
        }

        .task-item-status.running {
            background: #00a8cc;
        }

        .task-item-status.completed {
            background: #10b981;
        }

        .task-item-status.failed {
            background: #ef4444;
        }

        .task-item-desc {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .task-progress {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: #00a8cc;
            transition: width 0.3s;
        }

        .task-item-time {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
        }

        .task-empty {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Inpods Curriculum Mapping</h1>
            <span class="version-badge">V2</span>
        </div>
        <p class="subtitle">Analyze and improve question-to-curriculum mappings</p>

        <div id="status" class="status"></div>

        <!-- Task Notification Panel -->
        <div id="taskPanel" class="task-panel collapsed">
            <div class="task-panel-header" onclick="toggleTaskPanel()">
                <span class="task-panel-title">
                    <span class="task-icon" id="taskSpinner">&#9881;</span> Tasks
                    <span class="task-count" id="activeTaskCount">0</span>
                </span>
                <span id="taskPanelToggleIcon">&#9650;</span>
            </div>
            <div class="task-panel-body" id="taskPanelBody">
                <div class="task-list" id="taskList">
                    <div class="task-empty">No tasks yet</div>
                </div>
            </div>
        </div>

        <!-- Mode Selection -->
        <div id="modeSelection">
            <div class="mode-selection">
                <div class="mode-card mode-a" onclick="selectMode('A')">
                    <div class="mode-label">MODE A</div>
                    <div class="mode-icon">&#128269;</div>
                    <h3>Map Unmapped Questions</h3>
                    <p>Upload questions without mappings and get AI-recommended curriculum mappings with confidence scores.</p>
                </div>

                <div class="mode-card mode-b" onclick="selectMode('B')">
                    <div class="mode-label">MODE B</div>
                    <div class="mode-icon">&#9733;</div>
                    <h3>Analyze & Improve Mappings</h3>
                    <p>Upload pre-mapped questions to evaluate accuracy and get alternative recommendations where needed.</p>
                </div>

                <div class="mode-card mode-c" onclick="selectMode('C')">
                    <div class="mode-label">MODE C</div>
                    <div class="mode-icon">&#128202;</div>
                    <h3>Generate Insights</h3>
                    <p>Visualize mapping distribution, confidence scores, and curriculum coverage gaps.</p>
                </div>
            </div>
        </div>

        <!-- Main Layout with Sidebar -->
        <div id="mainContent" class="main-layout hidden">
            <!-- Sidebar: Library -->
            <div class="sidebar" id="librarySidebar">
                <div class="sidebar-title">
                    <span>&#128218;</span> Saved Mappings
                </div>
                <ul class="library-list" id="libraryList">
                    <li class="library-empty">No saved mappings yet</li>
                </ul>
            </div>

            <!-- Main Area -->
            <div class="main-area">
                <!-- ==================== MODE A: Map Unmapped ==================== -->
                <div id="modeA" class="hidden">
                    <button class="secondary back-btn" onclick="goBack()">&#8592; Back to Mode Selection</button>

                    <!-- Step 1: Upload Files -->
                    <div class="card" id="uploadSectionA">
                        <div class="section-title">Mode A: Map Unmapped Questions</div>

                        <div class="form-group">
                            <label>Question Bank CSV (unmapped)</label>
                            <input type="file" id="questionFileA" accept=".csv,.xlsx,.xls">
                        </div>

                        <div class="form-group">
                            <label>Reference Sheet CSV</label>
                            <input type="file" id="referenceFileA" accept=".csv,.xlsx,.xls">
                        </div>

                        <div class="form-group">
                            <label>Map To Dimensions (select one or more)</label>
                            <div class="dimension-checkboxes" id="dimensionsA">
                                <label>
                                    <input type="checkbox" value="competency" checked>
                                    <span class="dim-label">Competency</span>
                                    <span class="dim-code">C1-C6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="objective">
                                    <span class="dim-label">Objective</span>
                                    <span class="dim-code">O1-O6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="skill">
                                    <span class="dim-label">Skill</span>
                                    <span class="dim-code">S1-S5</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="nmc_competency">
                                    <span class="dim-label">NMC Competency</span>
                                    <span class="dim-code">MI1-MI3</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="area_topics">
                                    <span class="dim-label">Topic Areas</span>
                                    <span class="dim-code">Topic/Subtopic</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="blooms">
                                    <span class="dim-label">Blooms Level</span>
                                    <span class="dim-code">KL1-KL6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="complexity">
                                    <span class="dim-label">Complexity</span>
                                    <span class="dim-code">Easy/Med/Hard</span>
                                </label>
                            </div>
                            <div class="dimension-validation-error" id="dimensionErrorA">Please select at least one dimension to map</div>
                        </div>

                        <div class="form-group" style="background: #f0fdf4; padding: 15px; border-radius: 6px; border: 1px solid #bbf7d0;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="efficientModeA" checked style="width: 18px; height: 18px;">
                                <span>Use Efficient Mode (Recommended)</span>
                            </label>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">
                                Processes questions in batches to reduce API costs by 60-70%.
                            </p>
                            <div id="batchSizeGroupA">
                                <label style="font-size: 13px;">Batch Size:</label>
                                <select id="batchSizeA" style="width: auto; padding: 6px 10px;">
                                    <option value="3">3 questions per batch</option>
                                    <option value="5" selected>5 questions per batch (Recommended)</option>
                                    <option value="7">7 questions per batch</option>
                                    <option value="10">10 questions per batch</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="uploadAndPreviewA()">Upload & Preview</button>
                    </div>

                    <!-- File Overview (Metadata Preview) -->
                    <div class="card hidden" id="fileOverviewA">
                        <div class="section-title">File Overview</div>
                        <p style="color: #64748b; margin-bottom: 20px;">Review the uploaded files before running the audit.</p>

                        <!-- Question File Overview -->
                        <div class="overview-section">
                            <h4 style="color: #1e293b; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">&#128196;</span> Question Bank
                            </h4>
                            <div id="questionOverviewA" class="overview-content">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Reference File Overview -->
                        <div class="overview-section" style="margin-top: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">&#128218;</span> Curriculum Reference
                            </h4>
                            <div id="referenceOverviewA" class="overview-content">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="actions" style="margin-top: 25px;">
                            <button onclick="runAuditA()">Run Audit</button>
                            <button class="secondary" onclick="backToUploadA()">Change Files</button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="card hidden" id="loadingA">
                        <div class="spinner"></div>
                        <p>Running audit... This may take a few minutes depending on the number of questions.</p>
                    </div>

                    <!-- Recommendations -->
                    <div class="card hidden" id="recommendationsSectionA">
                        <div class="section-title">Review Recommendations</div>

                        <!-- Token Usage Display -->
                        <div class="token-usage" id="tokenUsageA">
                            <span class="token-usage-title">API Token Usage</span>
                            <div class="token-stat">
                                <span class="token-stat-value" id="promptTokensA">0</span>
                                <span class="token-stat-label">Prompt</span>
                            </div>
                            <div class="token-stat">
                                <span class="token-stat-value" id="completionTokensA">0</span>
                                <span class="token-stat-label">Completion</span>
                            </div>
                            <div class="token-stat total">
                                <span class="token-stat-value" id="totalTokensA">0</span>
                                <span class="token-stat-label">Total</span>
                            </div>
                            <div class="token-stat api-calls">
                                <span class="token-stat-value" id="apiCallsA">0</span>
                                <span class="token-stat-label">API Calls</span>
                            </div>
                        </div>

                        <div class="selection-info">
                            <span id="selectionCountA">0</span> of <span id="totalCountA">0</span> recommendations selected
                        </div>

                        <div style="margin-bottom: 15px;">
                            <button class="small" onclick="selectAllA()">Select All</button>
                            <button class="small secondary" onclick="selectNoneA()">Select None</button>
                            <button class="small" onclick="selectHighConfidenceA()">Select High Confidence (&ge;0.85)</button>
                        </div>

                        <div class="table-wrapper">
                            <table class="recommendations-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" class="checkbox" id="selectAllCheckboxA" onchange="toggleSelectAllA()">
                                        </th>
                                        <th style="width: 80px;">Q#</th>
                                        <th style="width: 350px;">Question (Full Text)</th>
                                        <th style="width: 120px;">Mapping Code</th>
                                        <th style="width: 280px;">Definition</th>
                                        <th style="width: 100px;">Confidence</th>
                                        <th>Justification</th>
                                    </tr>
                                </thead>
                                <tbody id="recommendationsBodyA"></tbody>
                            </table>
                        </div>

                        <div class="actions">
                            <button class="success" onclick="saveAndDownloadA()">Save & Download</button>
                            <button class="secondary" onclick="startOverA()">Start Over</button>
                        </div>
                    </div>
                </div>

                <!-- ==================== MODE B: Rate Existing ==================== -->
                <div id="modeB" class="hidden">
                    <button class="secondary back-btn" onclick="goBack()">&#8592; Back to Mode Selection</button>

                    <!-- Upload -->
                    <div class="card" id="uploadSectionB">
                        <div class="section-title">Mode B: Analyze & Improve Mappings</div>

                        <div class="form-group">
                            <label>Mapped Questions File (with existing mappings)</label>
                            <input type="file" id="mappedFileB" accept=".csv,.xlsx,.xls,.ods">
                        </div>

                        <div class="form-group">
                            <label>Reference Sheet CSV</label>
                            <input type="file" id="referenceFileB" accept=".csv,.xlsx,.xls">
                        </div>

                        <div class="form-group">
                            <label>Rate Dimensions (select one or more)</label>
                            <div class="dimension-checkboxes" id="dimensionsB">
                                <label>
                                    <input type="checkbox" value="competency" checked>
                                    <span class="dim-label">Competency</span>
                                    <span class="dim-code">C1-C6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="objective">
                                    <span class="dim-label">Objective</span>
                                    <span class="dim-code">O1-O6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="skill">
                                    <span class="dim-label">Skill</span>
                                    <span class="dim-code">S1-S5</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="nmc_competency">
                                    <span class="dim-label">NMC Competency</span>
                                    <span class="dim-code">MI1-MI3</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="area_topics">
                                    <span class="dim-label">Topic Areas</span>
                                    <span class="dim-code">Topic/Subtopic</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="blooms">
                                    <span class="dim-label">Blooms Level</span>
                                    <span class="dim-code">KL1-KL6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="complexity">
                                    <span class="dim-label">Complexity</span>
                                    <span class="dim-code">Easy/Med/Hard</span>
                                </label>
                            </div>
                            <div class="dimension-validation-error" id="dimensionErrorB">Please select at least one dimension to rate</div>
                        </div>

                        <div class="form-group">
                            <label>Batch Size:</label>
                            <select id="batchSizeB" style="width: auto; padding: 6px 10px;">
                                <option value="3">3 questions per batch</option>
                                <option value="5" selected>5 questions per batch</option>
                                <option value="7">7 questions per batch</option>
                            </select>
                        </div>

                        <button onclick="uploadAndRateB()">Upload & Analyze</button>
                    </div>

                    <!-- Loading -->
                    <div class="card hidden" id="loadingB">
                        <div class="spinner"></div>
                        <p>Analyzing existing mappings... This may take a few minutes.</p>
                    </div>

                    <!-- Ratings Results -->
                    <div class="card hidden" id="ratingsSectionB">
                        <div class="section-title">Mapping Analysis Results</div>

                        <!-- Token Usage Display -->
                        <div class="token-usage" id="tokenUsageB">
                            <span class="token-usage-title">API Token Usage</span>
                            <div class="token-stat">
                                <span class="token-stat-value" id="promptTokensB">0</span>
                                <span class="token-stat-label">Prompt</span>
                            </div>
                            <div class="token-stat">
                                <span class="token-stat-value" id="completionTokensB">0</span>
                                <span class="token-stat-label">Completion</span>
                            </div>
                            <div class="token-stat total">
                                <span class="token-stat-value" id="totalTokensB">0</span>
                                <span class="token-stat-label">Total</span>
                            </div>
                            <div class="token-stat api-calls">
                                <span class="token-stat-value" id="apiCallsB">0</span>
                                <span class="token-stat-label">API Calls</span>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="rating-summary">
                            <div class="rating-stat correct">
                                <div class="stat-value" id="correctCountB">0</div>
                                <div class="stat-label">Correct</div>
                            </div>
                            <div class="rating-stat partial">
                                <div class="stat-value" id="partialCountB">0</div>
                                <div class="stat-label">Partially Correct</div>
                            </div>
                            <div class="rating-stat incorrect">
                                <div class="stat-value" id="incorrectCountB">0</div>
                                <div class="stat-label">Incorrect</div>
                            </div>
                        </div>

                        <div class="selection-info">
                            Showing <span id="needsReviewCountB">0</span> mappings that need review.
                            <span id="selectionCountB">0</span> selected for update.
                        </div>

                        <div style="margin-bottom: 15px;">
                            <button class="small" onclick="selectAllIncorrectB()">Select All Incorrect</button>
                            <button class="small secondary" onclick="selectNoneB()">Select None</button>
                        </div>

                        <div class="table-wrapper">
                            <table class="recommendations-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" class="checkbox" id="selectAllCheckboxB" onchange="toggleSelectAllB()">
                                        </th>
                                        <th style="width: 70px;">Q#</th>
                                        <th style="width: 250px;">Question</th>
                                        <th style="width: 100px;">Original Code</th>
                                        <th style="width: 90px;">Rating</th>
                                        <th style="width: 100px;">Suggested Code</th>
                                        <th style="width: 200px;">Definition</th>
                                        <th style="width: 80px;">Confidence</th>
                                        <th style="width: 200px;">Justification</th>
                                    </tr>
                                </thead>
                                <tbody id="ratingsBodyB"></tbody>
                            </table>
                        </div>

                        <div class="actions">
                            <button class="success" onclick="saveAndDownloadB()">Save & Download Corrections</button>
                            <button class="secondary" onclick="startOverB()">Start Over</button>
                        </div>
                    </div>
                </div>

                <!-- ==================== MODE C: Insights ==================== -->
                <div id="modeC" class="hidden">
                    <button class="secondary back-btn" onclick="goBack()">&#8592; Back to Mode Selection</button>

                    <!-- Upload -->
                    <div class="card" id="uploadSectionC">
                        <div class="section-title">Mode C: Generate Insights</div>

                        <div class="form-group">
                            <label>Mapped Questions File</label>
                            <input type="file" id="mappedFileC" accept=".csv,.xlsx,.xls,.ods">
                        </div>

                        <div class="form-group">
                            <label>Reference Sheet CSV (optional, for gap analysis)</label>
                            <input type="file" id="referenceFileC" accept=".csv,.xlsx,.xls">
                        </div>

                        <div class="form-group">
                            <label>Visualize Dimensions (select one or more)</label>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">
                                Select which dimensions to analyze. Separate charts will be generated for each dimension.
                            </p>
                            <div class="dimension-checkboxes" id="dimensionsC">
                                <label>
                                    <input type="checkbox" value="competency">
                                    <span class="dim-label">Competency</span>
                                    <span class="dim-code">C1-C6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="objective">
                                    <span class="dim-label">Objective</span>
                                    <span class="dim-code">O1-O6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="skill">
                                    <span class="dim-label">Skill</span>
                                    <span class="dim-code">S1-S5</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="nmc_competency">
                                    <span class="dim-label">NMC Competency</span>
                                    <span class="dim-code">MI1-MI3</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="area_topics">
                                    <span class="dim-label">Topic Areas</span>
                                    <span class="dim-code">Topic/Subtopic</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="blooms">
                                    <span class="dim-label">Blooms Level</span>
                                    <span class="dim-code">KL1-KL6</span>
                                </label>
                                <label>
                                    <input type="checkbox" value="complexity">
                                    <span class="dim-label">Complexity</span>
                                    <span class="dim-code">Easy/Med/Hard</span>
                                </label>
                            </div>
                            <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                                Leave empty to auto-detect dimensions from file
                            </p>
                        </div>

                        <button onclick="generateInsightsC()">Generate Insights</button>
                    </div>

                    <!-- Loading -->
                    <div class="card hidden" id="loadingC">
                        <div class="spinner"></div>
                        <p>Generating visualizations...</p>
                    </div>

                    <!-- Charts -->
                    <div class="card hidden" id="insightsSectionC">
                        <div class="section-title">Curriculum Mapping Insights</div>

                        <div class="summary-stats" id="summaryStatsC">
                            <!-- Populated by JS -->
                        </div>

                        <div class="charts-grid" id="chartsGridC">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Coverage Table -->
                        <div class="coverage-table-section" id="coverageTableSectionC">
                            <h4>Coverage Analysis: Code - Definition - Questions - Percentage</h4>
                            <div class="table-wrapper">
                                <table class="coverage-table" id="coverageTableC">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Code</th>
                                            <th>Definition</th>
                                            <th style="width: 100px; text-align: center;">Questions</th>
                                            <th style="width: 120px; text-align: center;">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="coverageTableBodyC">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="actions">
                            <button class="secondary" onclick="startOverC()">Start Over</button>
                        </div>
                    </div>
                </div>

                <!-- ==================== View from Library ==================== -->
                <div id="libraryView" class="hidden">
                    <button class="secondary back-btn" onclick="goBack()">&#8592; Back to Mode Selection</button>

                    <div class="card">
                        <div class="section-title" id="libraryViewTitle">Saved Mapping</div>

                        <div class="selection-info">
                            <span id="libraryViewCount">0</span> mappings |
                            Created: <span id="libraryViewDate">-</span> |
                            Dimension: <span id="libraryViewDimension">-</span> |
                            Mode: <span id="libraryViewMode">-</span>
                        </div>

                        <div class="table-wrapper">
                            <table class="recommendations-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Q#</th>
                                        <th style="width: 350px;">Question (Full Text)</th>
                                        <th>Mapping</th>
                                        <th style="width: 80px;">Confidence</th>
                                        <th>Justification</th>
                                    </tr>
                                </thead>
                                <tbody id="libraryViewBody"></tbody>
                            </table>
                        </div>

                        <div class="actions">
                            <button onclick="exportLibraryItem()">Export to Excel</button>
                            <button class="danger" onclick="deleteLibraryItem()">Delete</button>
                            <button class="secondary" onclick="goBack()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Modal -->
    <div id="saveModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>Save & Download</h3>
            <div class="form-group">
                <label>Name for this mapping set</label>
                <input type="text" id="saveName" placeholder="Enter a name for this mapping set">
            </div>
            <p style="font-size: 13px; color: #64748b; margin-top: 10px;">
                This will save to your library AND download an Excel file.
            </p>
            <div class="modal-actions">
                <button class="secondary" onclick="closeSaveModal()">Cancel</button>
                <button onclick="confirmSaveAndDownload()">Save & Download</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api';
        const BASE_URL = 'http://localhost:5001';  // For direct file downloads

        // ==================== TASK MANAGER ====================
        const TaskState = {
            PENDING: 'pending',
            RUNNING: 'running',
            COMPLETED: 'completed',
            FAILED: 'failed'
        };

        class TaskManager {
            constructor() {
                this.tasks = new Map();
                this.counter = 0;
            }

            create(type, description) {
                const id = `task_${++this.counter}_${Date.now()}`;
                const task = {
                    id,
                    type,
                    description,
                    state: TaskState.PENDING,
                    progress: 0,
                    startTime: null,
                    endTime: null,
                    result: null,
                    error: null
                };
                this.tasks.set(id, task);
                this.render();
                return id;
            }

            async run(taskId, asyncFn) {
                const task = this.tasks.get(taskId);
                if (!task) return null;

                task.state = TaskState.RUNNING;
                task.startTime = Date.now();
                this.render();

                try {
                    task.result = await asyncFn((p) => {
                        task.progress = p;
                        this.render();
                    });
                    task.state = TaskState.COMPLETED;
                } catch (e) {
                    task.state = TaskState.FAILED;
                    task.error = e.message;
                }

                task.endTime = Date.now();
                this.render();
                this.notifyComplete(task);
                return task;
            }

            notifyComplete(task) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    const icon = task.state === TaskState.COMPLETED ? '\u2713' : '\u2717';
                    new Notification(`${icon} ${this.getTypeLabel(task.type)}`, {
                        body: task.description
                    });
                }
                // Also show status bar notification
                const type = task.state === TaskState.COMPLETED ? 'success' : 'error';
                showStatus(`${this.getTypeLabel(task.type)}: ${task.state === TaskState.COMPLETED ? 'Complete' : task.error}`, type);
            }

            getTypeLabel(type) {
                const labels = {
                    'mode_a': 'Mode A Mapping',
                    'mode_b': 'Mode B Rating',
                    'mode_c': 'Mode C Insights'
                };
                return labels[type] || type;
            }

            getActive() {
                return [...this.tasks.values()].filter(t => t.state === TaskState.RUNNING);
            }

            getAll() {
                return [...this.tasks.values()].sort((a, b) => (b.startTime || 0) - (a.startTime || 0));
            }

            render() {
                const tasks = this.getAll();
                const active = this.getActive();
                const panel = document.getElementById('taskPanel');
                const list = document.getElementById('taskList');
                const count = document.getElementById('activeTaskCount');

                count.textContent = active.length;
                count.classList.toggle('zero', active.length === 0);
                panel.classList.toggle('has-active', active.length > 0);

                if (tasks.length === 0) {
                    list.innerHTML = '<div class="task-empty">No tasks yet</div>';
                    return;
                }

                list.innerHTML = tasks.slice(0, 10).map(t => {
                    const dur = t.endTime
                        ? this.formatDur(t.endTime - t.startTime)
                        : t.startTime
                            ? this.formatDur(Date.now() - t.startTime) + '...'
                            : '';
                    return `
                        <div class="task-item ${t.state}">
                            <div class="task-item-header">
                                <span class="task-item-type">${this.getTypeLabel(t.type)}</span>
                                <span class="task-item-status ${t.state}">${t.state}</span>
                            </div>
                            <div class="task-item-desc">${t.description}</div>
                            ${t.state === 'running' ? `<div class="task-progress"><div class="task-progress-fill" style="width:${t.progress}%"></div></div>` : ''}
                            ${dur ? `<div class="task-item-time">${dur}</div>` : ''}
                            ${t.error ? `<div class="task-item-desc" style="color:#ef4444">${t.error}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            formatDur(ms) {
                const s = Math.floor(ms / 1000);
                return s < 60 ? `${s}s` : `${Math.floor(s / 60)}m ${s % 60}s`;
            }
        }

        const taskManager = new TaskManager();

        function toggleTaskPanel() {
            const panel = document.getElementById('taskPanel');
            const icon = document.getElementById('taskPanelToggleIcon');
            panel.classList.toggle('collapsed');
            icon.textContent = panel.classList.contains('collapsed') ? '\u25B2' : '\u25BC';
        }

        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        let currentMode = null;
        let currentLibraryId = null;
        let uploadedFilesA = { questionFile: null, referenceFile: null };
        let uploadedFilesB = { mappedFile: null, referenceFile: null };
        let uploadedFilesC = { mappedFile: null, referenceFile: null };
        let recommendationsA = [];
        let referenceDefinitionsA = {};
        let currentDimensionsA = [];  // V2.1: Track selected dimensions for Mode A
        let currentDimensionsB = [];  // V2.1: Track selected dimensions for Mode B
        let ratingsB = [];
        let recommendationsB = [];
        let selectedIndicesA = [];
        let selectedIndicesB = [];
        let pendingSaveData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadLibrary();
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => { status.className = 'status'; }, 5000);
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('modeA').classList.add('hidden');
            document.getElementById('modeB').classList.add('hidden');
            document.getElementById('modeC').classList.add('hidden');
            document.getElementById('libraryView').classList.add('hidden');
            document.getElementById(`mode${mode}`).classList.remove('hidden');
            loadLibrary();
        }

        function goBack() {
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            currentMode = null;
            currentLibraryId = null;
        }

        // ==================== LIBRARY FUNCTIONS ====================
        async function loadLibrary() {
            try {
                const response = await fetch(`${API_URL}/library`);
                const data = await response.json();

                const list = document.getElementById('libraryList');

                if (data.mappings && data.mappings.length > 0) {
                    list.innerHTML = data.mappings.map(m => `
                        <li class="library-item ${currentLibraryId === m.id ? 'active' : ''}"
                            onclick="openLibraryItem('${m.id}')">
                            <div class="library-item-name">
                                ${m.name}
                                <span class="library-item-mode mode-${m.mode.toLowerCase()}">${m.mode}</span>
                            </div>
                            <div class="library-item-meta">
                                ${m.question_count} questions | ${new Date(m.created_at).toLocaleDateString()}
                            </div>
                        </li>
                    `).join('');
                } else {
                    list.innerHTML = '<li class="library-empty">No saved mappings yet</li>';
                }
            } catch (error) {
                console.error('Failed to load library:', error);
            }
        }

        async function openLibraryItem(id) {
            try {
                const response = await fetch(`${API_URL}/library/${id}`);
                const data = await response.json();

                if (data.status === 'success') {
                    currentLibraryId = id;
                    const mapping = data.mapping;

                    document.getElementById('modeA').classList.add('hidden');
                    document.getElementById('modeB').classList.add('hidden');
                    document.getElementById('modeC').classList.add('hidden');
                    document.getElementById('libraryView').classList.remove('hidden');

                    document.getElementById('libraryViewTitle').textContent = mapping.name;
                    document.getElementById('libraryViewCount').textContent = mapping.question_count;
                    document.getElementById('libraryViewDate').textContent = new Date(mapping.created_at).toLocaleString();
                    document.getElementById('libraryViewDimension').textContent = mapping.dimension;
                    document.getElementById('libraryViewMode').textContent = mapping.mode === 'A' ? 'New Mappings' : 'Corrections';

                    const tbody = document.getElementById('libraryViewBody');
                    tbody.innerHTML = '';

                    mapping.recommendations.forEach(rec => {
                        const row = document.createElement('tr');
                        const confidence = rec.confidence || 0;
                        let confidenceClass = 'confidence-low';
                        if (confidence >= 0.85) confidenceClass = 'confidence-high';
                        else if (confidence >= 0.70) confidenceClass = 'confidence-medium';

                        row.innerHTML = `
                            <td>${rec.question_num}</td>
                            <td class="question-text">
                                <div class="question-text-full">${rec.question_text || ''}</div>
                            </td>
                            <td>${rec.recommended_mapping || rec.mapped_topic || ''}</td>
                            <td><span class="confidence-badge ${confidenceClass}">${Math.round(confidence * 100)}%</span></td>
                            <td class="justification">${rec.justification || ''}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    loadLibrary();
                }
            } catch (error) {
                showStatus(`Error loading mapping: ${error.message}`, 'error');
            }
        }

        async function exportLibraryItem() {
            if (!currentLibraryId) return;

            try {
                const response = await fetch(`${API_URL}/library/${currentLibraryId}/export`);
                const data = await response.json();

                if (data.status === 'success') {
                    window.location.href = `${BASE_URL}${data.download_url}`;
                    showStatus('Exporting...', 'success');
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function deleteLibraryItem() {
            if (!currentLibraryId) return;
            if (!confirm('Are you sure you want to delete this mapping?')) return;

            try {
                const response = await fetch(`${API_URL}/library/${currentLibraryId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showStatus('Mapping deleted', 'success');
                    currentLibraryId = null;
                    goBack();
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function openSaveModal(recommendations, mode, sourceFile) {
            // V2.1: Get dimensions array from checkboxes
            const dimensions = getSelectedDimensions(`dimensions${mode}`);
            pendingSaveData = {
                recommendations,
                mode,
                sourceFile,
                dimensions: dimensions,
                dimension: dimensions[0] || 'competency'  // Backward compat
            };
            document.getElementById('saveName').value = `Mapping_${new Date().toISOString().slice(0, 10)}`;
            document.getElementById('saveModal').classList.remove('hidden');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.add('hidden');
            pendingSaveData = null;
        }

        async function confirmSaveAndDownload() {
            if (!pendingSaveData) return;

            const name = document.getElementById('saveName').value.trim() || 'Unnamed Mapping';
            const mode = pendingSaveData.mode;

            try {
                let endpoint, body;

                if (mode === 'A') {
                    endpoint = '/apply-and-save';
                    body = {
                        question_file: uploadedFilesA.questionFile,
                        recommendations: pendingSaveData.recommendations,
                        selected_indices: selectedIndicesA,
                        dimensions: pendingSaveData.dimensions,  // V2.1: Send dimensions array
                        dimension: pendingSaveData.dimension,
                        name: name
                    };
                } else {
                    endpoint = '/apply-corrections-and-save';
                    body = {
                        mapped_file: uploadedFilesB.mappedFile,
                        recommendations: pendingSaveData.recommendations,
                        selected_indices: selectedIndicesB,
                        dimensions: pendingSaveData.dimensions,  // V2.1: Send dimensions array
                        dimension: pendingSaveData.dimension,
                        name: name
                    };
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showStatus(`Saved "${name}" to library and downloading...`, 'success');
                    closeSaveModal();
                    loadLibrary();
                    // Trigger download
                    window.location.href = `${BASE_URL}${data.download_url}`;
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // ==================== MODE A FUNCTIONS ====================
        let uploadMetadataA = null;  // Store metadata from upload

        async function uploadAndPreviewA() {
            const questionFile = document.getElementById('questionFileA').files[0];
            const referenceFile = document.getElementById('referenceFileA').files[0];

            if (!questionFile || !referenceFile) {
                showStatus('Please select both files', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('question_file', questionFile);
            formData.append('reference_file', referenceFile);

            try {
                const uploadResponse = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
                const uploadData = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    showStatus(`Error: ${uploadData.error}`, 'error');
                    return;
                }

                uploadedFilesA.questionFile = uploadData.question_file;
                uploadedFilesA.referenceFile = uploadData.reference_file;
                uploadMetadataA = {
                    question: uploadData.question_metadata,
                    reference: uploadData.reference_metadata
                };

                // Display file overview
                displayFileOverviewA(uploadData);

                document.getElementById('uploadSectionA').classList.add('hidden');
                document.getElementById('fileOverviewA').classList.remove('hidden');

                showStatus(`Files uploaded successfully`, 'success');

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function displayFileOverviewA(data) {
            // Question Overview
            const qMeta = data.question_metadata || {};
            let qHtml = `
                <div class="overview-stats">
                    <div class="overview-stat">
                        <div class="overview-stat-value">${qMeta.total_questions || data.question_count || 0}</div>
                        <div class="overview-stat-label">Questions</div>
                    </div>
                    <div class="overview-stat">
                        <div class="overview-stat-value">${(qMeta.columns || []).length}</div>
                        <div class="overview-stat-label">Columns</div>
                    </div>
                </div>
            `;

            if (qMeta.sample_questions && qMeta.sample_questions.length > 0) {
                qHtml += `<div class="sample-questions"><strong>Sample Questions:</strong>`;
                qMeta.sample_questions.forEach(q => {
                    qHtml += `
                        <div class="sample-question">
                            <div class="sample-question-num">Q${q.number}</div>
                            <div class="sample-question-text">${q.text}</div>
                        </div>
                    `;
                });
                qHtml += `</div>`;
            }

            document.getElementById('questionOverviewA').innerHTML = qHtml;

            // Reference Overview
            const rMeta = data.reference_metadata || {};
            let rHtml = `<div class="overview-stats">`;

            const totalItems =
                (rMeta.competencies || []).length +
                (rMeta.objectives || []).length +
                (rMeta.skills || []).length +
                (rMeta.topics || []).length +
                (rMeta.nmc_competencies || []).length +
                (rMeta.blooms || []).length +
                (rMeta.complexity || []).length;

            rHtml += `
                <div class="overview-stat">
                    <div class="overview-stat-value">${totalItems}</div>
                    <div class="overview-stat-label">Total Items</div>
                </div>
            `;

            if (rMeta.detected_type) {
                rHtml += `
                    <div class="overview-stat">
                        <div class="overview-stat-value" style="font-size: 16px;">${rMeta.detected_type.replace('_', ' ').toUpperCase()}</div>
                        <div class="overview-stat-label">Detected Type</div>
                    </div>
                `;
            }
            rHtml += `</div>`;

            rHtml += `<ul class="curriculum-list">`;

            // NMC Competencies
            if (rMeta.nmc_competencies && rMeta.nmc_competencies.length > 0) {
                rHtml += `<div class="curriculum-type-header">NMC Competencies <span class="curriculum-count">${rMeta.nmc_competencies.length}</span></div>`;
                rMeta.nmc_competencies.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item nmc">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            // Competencies
            if (rMeta.competencies && rMeta.competencies.length > 0) {
                rHtml += `<div class="curriculum-type-header">Competencies <span class="curriculum-count">${rMeta.competencies.length}</span></div>`;
                rMeta.competencies.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item competency">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            // Objectives
            if (rMeta.objectives && rMeta.objectives.length > 0) {
                rHtml += `<div class="curriculum-type-header">Objectives <span class="curriculum-count">${rMeta.objectives.length}</span></div>`;
                rMeta.objectives.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item objective">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            // Skills
            if (rMeta.skills && rMeta.skills.length > 0) {
                rHtml += `<div class="curriculum-type-header">Skills <span class="curriculum-count">${rMeta.skills.length}</span></div>`;
                rMeta.skills.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item skill">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            // Topics
            if (rMeta.topics && rMeta.topics.length > 0) {
                rHtml += `<div class="curriculum-type-header">Topic Areas <span class="curriculum-count">${rMeta.topics.length}</span></div>`;
                rMeta.topics.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item topic">
                            <span class="curriculum-id">${item.topic}</span>
                            ${item.subtopics ? `<span class="curriculum-desc">${item.subtopics}</span>` : ''}
                        </li>
                    `;
                });
            }

            // Blooms Levels
            if (rMeta.blooms && rMeta.blooms.length > 0) {
                rHtml += `<div class="curriculum-type-header">Blooms Levels <span class="curriculum-count">${rMeta.blooms.length}</span></div>`;
                rMeta.blooms.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item blooms">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            // Complexity Levels
            if (rMeta.complexity && rMeta.complexity.length > 0) {
                rHtml += `<div class="curriculum-type-header">Complexity Levels <span class="curriculum-count">${rMeta.complexity.length}</span></div>`;
                rMeta.complexity.forEach(item => {
                    rHtml += `
                        <li class="curriculum-item complexity">
                            <span class="curriculum-id">${item.id}</span>
                            <span class="curriculum-desc">${item.description}</span>
                        </li>
                    `;
                });
            }

            rHtml += `</ul>`;

            if (totalItems === 0) {
                rHtml = `<p style="color: #64748b; text-align: center; padding: 20px;">No curriculum items detected in reference file. Please ensure the file contains competencies (C1-C6), objectives (O1-O6), skills (S1-S5), NMC codes (MI1.1, etc.), Blooms levels (KL1-KL6), or complexity levels (Easy/Medium/Hard).</p>`;
            }

            document.getElementById('referenceOverviewA').innerHTML = rHtml;
        }

        function backToUploadA() {
            document.getElementById('fileOverviewA').classList.add('hidden');
            document.getElementById('uploadSectionA').classList.remove('hidden');
        }

        // V2.1: Helper function to get selected dimensions from checkboxes
        function getSelectedDimensions(containerId) {
            const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function runAuditA() {
            // V2.1: Get selected dimensions from checkboxes
            const dimensions = getSelectedDimensions('dimensionsA');

            // Validate at least one dimension selected
            if (dimensions.length === 0) {
                document.getElementById('dimensionErrorA').classList.add('show');
                showStatus('Please select at least one dimension to map', 'error');
                return;
            }
            document.getElementById('dimensionErrorA').classList.remove('show');

            // Get question count and dimension names for task description
            const qCount = uploadMetadataA?.question?.total_questions || '?';
            const dimNames = dimensions.map(d => d.replace('_', ' ')).join(', ');

            // Create task (non-blocking)
            const taskId = taskManager.create('mode_a', `Mapping ${qCount} questions to ${dimNames}`);

            // Show loading but allow interaction
            document.getElementById('fileOverviewA').classList.add('hidden');
            document.getElementById('loadingA').classList.remove('hidden');

            // Run async with task tracking
            const task = await taskManager.run(taskId, async (updateProgress) => {
                const useEfficient = document.getElementById('efficientModeA').checked;
                const batchSize = parseInt(document.getElementById('batchSizeA').value);
                const endpoint = useEfficient ? '/run-audit-efficient' : '/run-audit';

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question_file: uploadedFilesA.questionFile,
                        reference_file: uploadedFilesA.referenceFile,
                        dimensions: dimensions,
                        dimension: dimensions[0],
                        batch_size: batchSize
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Audit failed');
                }

                return await response.json();
            });

            document.getElementById('loadingA').classList.add('hidden');

            if (task.state === TaskState.COMPLETED) {
                const data = task.result;
                recommendationsA = data.recommendations;
                referenceDefinitionsA = data.reference_definitions || {};
                currentDimensionsA = dimensions;
                displayRecommendationsA(recommendationsA, referenceDefinitionsA, dimensions);

                if (data.token_usage) {
                    displayTokenUsageA(data.token_usage);
                }

                document.getElementById('recommendationsSectionA').classList.remove('hidden');
            } else {
                document.getElementById('fileOverviewA').classList.remove('hidden');
            }
        }

        function displayRecommendationsA(recs, definitions = {}, dimensions = []) {
            const tbody = document.getElementById('recommendationsBodyA');
            const thead = document.querySelector('#recommendationsSectionA thead tr');
            tbody.innerHTML = '';
            document.getElementById('totalCountA').textContent = recs.length;

            // V2.1: Build dynamic column headers based on dimensions
            const dimensionLabels = {
                'competency': 'Competency',
                'objective': 'Objective',
                'skill': 'Skill',
                'nmc_competency': 'NMC',
                'area_topics': 'Topic',
                'blooms': 'Blooms',
                'complexity': 'Complexity'
            };

            // Update table headers for multi-dimension mode
            if (dimensions.length > 1) {
                let headerHtml = `
                    <th style="width: 40px;"><input type="checkbox" class="checkbox" id="selectAllCheckboxA" onchange="toggleSelectAllA()"></th>
                    <th style="width: 80px;">Q#</th>
                    <th style="width: 300px;">Question</th>
                `;
                dimensions.forEach(dim => {
                    headerHtml += `<th style="width: 100px;">${dimensionLabels[dim] || dim}</th>`;
                });
                headerHtml += `
                    <th style="width: 80px;">Conf</th>
                    <th>Justification</th>
                `;
                thead.innerHTML = headerHtml;
            }

            recs.forEach((rec, index) => {
                const row = document.createElement('tr');
                const confidence = rec.confidence || 0;
                let confidenceClass = 'confidence-low';
                if (confidence >= 0.85) confidenceClass = 'confidence-high';
                else if (confidence >= 0.70) confidenceClass = 'confidence-medium';

                // V2.1: Build row content based on dimensions
                if (dimensions.length > 1) {
                    // Multi-dimension mode - show each dimension in separate column
                    let rowHtml = `
                        <td><input type="checkbox" class="checkbox" data-index="${index}" onchange="updateSelectionA()"></td>
                        <td>${rec.question_num}</td>
                        <td class="question-text">
                            <div class="question-text-full">${rec.question_text || ''}</div>
                        </td>
                    `;

                    dimensions.forEach(dim => {
                        let code = '';
                        if (dim === 'area_topics') {
                            code = rec.mapped_topic || rec[`mapped_${dim}_topic`] || '';
                        } else {
                            code = rec[`mapped_${dim}`] || '';
                        }
                        const def = definitions[code] || '';
                        rowHtml += `<td><strong title="${def}">${code}</strong></td>`;
                    });

                    rowHtml += `
                        <td><span class="confidence-badge ${confidenceClass}">${Math.round(confidence * 100)}%</span></td>
                        <td class="justification">${rec.justification || ''}</td>
                    `;
                    row.innerHTML = rowHtml;
                } else {
                    // Single dimension mode - original display
                    const mappingCode = rec.recommended_mapping || rec.mapped_id || rec.mapped_competency || rec.mapped_objective || '';
                    const definition = definitions[mappingCode] || definitions[rec.mapped_id] || '';

                    row.innerHTML = `
                        <td><input type="checkbox" class="checkbox" data-index="${index}" onchange="updateSelectionA()"></td>
                        <td>${rec.question_num}</td>
                        <td class="question-text">
                            <div class="question-text-full">${rec.question_text || ''}</div>
                        </td>
                        <td><strong>${mappingCode}</strong></td>
                        <td class="definition-text">${definition}</td>
                        <td><span class="confidence-badge ${confidenceClass}">${Math.round(confidence * 100)}%</span></td>
                        <td class="justification">${rec.justification || ''}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }

        function displayTokenUsageA(tokenUsage) {
            document.getElementById('promptTokensA').textContent = tokenUsage.prompt_tokens.toLocaleString();
            document.getElementById('completionTokensA').textContent = tokenUsage.completion_tokens.toLocaleString();
            document.getElementById('totalTokensA').textContent = tokenUsage.total_tokens.toLocaleString();
            document.getElementById('apiCallsA').textContent = tokenUsage.api_calls || 0;
        }

        function updateSelectionA() {
            const checkboxes = document.querySelectorAll('#recommendationsBodyA input[type="checkbox"]');
            selectedIndicesA = [];
            checkboxes.forEach(cb => { if (cb.checked) selectedIndicesA.push(parseInt(cb.dataset.index)); });
            document.getElementById('selectionCountA').textContent = selectedIndicesA.length;
        }

        function toggleSelectAllA() {
            const selectAll = document.getElementById('selectAllCheckboxA').checked;
            document.querySelectorAll('#recommendationsBodyA input[type="checkbox"]').forEach(cb => cb.checked = selectAll);
            updateSelectionA();
        }

        function selectAllA() { document.getElementById('selectAllCheckboxA').checked = true; toggleSelectAllA(); }
        function selectNoneA() { document.getElementById('selectAllCheckboxA').checked = false; toggleSelectAllA(); }
        function selectHighConfidenceA() {
            document.querySelectorAll('#recommendationsBodyA input[type="checkbox"]').forEach((cb, i) => {
                cb.checked = recommendationsA[i].confidence >= 0.85;
            });
            updateSelectionA();
        }

        function saveAndDownloadA() {
            if (selectedIndicesA.length === 0) {
                showStatus('Please select at least one recommendation', 'error');
                return;
            }
            openSaveModal(recommendationsA, 'A', uploadedFilesA.questionFile);
        }

        function startOverA() {
            // V2: Reset within mode - clears form and results, stays in Mode A
            recommendationsA = [];
            selectedIndicesA = [];
            currentDimensionsA = [];
            uploadedFilesA = { questionFile: null, referenceFile: null };
            uploadMetadataA = null;
            document.getElementById('questionFileA').value = '';
            document.getElementById('referenceFileA').value = '';
            document.getElementById('recommendationsSectionA').classList.add('hidden');
            document.getElementById('loadingA').classList.add('hidden');
            document.getElementById('fileOverviewA').classList.add('hidden');
            document.getElementById('uploadSectionA').classList.remove('hidden');
            document.getElementById('selectionCountA').textContent = '0';
            document.getElementById('totalCountA').textContent = '0';
            document.getElementById('recommendationsBodyA').innerHTML = '';
            document.getElementById('selectAllCheckboxA').checked = false;
            // V2.1: Reset dimension checkboxes
            document.getElementById('dimensionErrorA').classList.remove('show');
            // Reset table header to default
            const thead = document.querySelector('#recommendationsSectionA thead tr');
            thead.innerHTML = `
                <th style="width: 40px;"><input type="checkbox" class="checkbox" id="selectAllCheckboxA" onchange="toggleSelectAllA()"></th>
                <th style="width: 80px;">Q#</th>
                <th style="width: 350px;">Question (Full Text)</th>
                <th style="width: 120px;">Mapping Code</th>
                <th style="width: 280px;">Definition</th>
                <th style="width: 100px;">Confidence</th>
                <th>Justification</th>
            `;
        }

        // ==================== MODE B FUNCTIONS ====================
        async function uploadAndRateB() {
            const mappedFile = document.getElementById('mappedFileB').files[0];
            const referenceFile = document.getElementById('referenceFileB').files[0];

            if (!mappedFile || !referenceFile) {
                showStatus('Please select both files', 'error');
                return;
            }

            // V2.1: Get selected dimensions from checkboxes
            const dimensions = getSelectedDimensions('dimensionsB');
            if (dimensions.length === 0) {
                document.getElementById('dimensionErrorB').classList.add('show');
                showStatus('Please select at least one dimension to rate', 'error');
                return;
            }
            document.getElementById('dimensionErrorB').classList.remove('show');

            const formData = new FormData();
            formData.append('mapped_file', mappedFile);
            formData.append('reference_file', referenceFile);

            try {
                // First upload the files
                const uploadResponse = await fetch(`${API_URL}/upload-mapped`, { method: 'POST', body: formData });
                const uploadData = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    showStatus(`Error: ${uploadData.error}`, 'error');
                    return;
                }

                uploadedFilesB.mappedFile = uploadData.mapped_file;
                uploadedFilesB.referenceFile = uploadData.reference_file;

                // Get dimension names for task description
                const dimNames = dimensions.map(d => d.replace('_', ' ')).join(', ');

                // Create task for the rating operation
                const taskId = taskManager.create('mode_b', `Rating mappings for ${dimNames}`);

                document.getElementById('uploadSectionB').classList.add('hidden');
                document.getElementById('loadingB').classList.remove('hidden');

                // Run async with task tracking
                const task = await taskManager.run(taskId, async (updateProgress) => {
                    const response = await fetch(`${API_URL}/rate-mappings`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            mapped_file: uploadedFilesB.mappedFile,
                            reference_file: uploadedFilesB.referenceFile,
                            dimensions: dimensions,
                            dimension: dimensions[0],
                            batch_size: parseInt(document.getElementById('batchSizeB').value)
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Rating failed');
                    }

                    return await response.json();
                });

                document.getElementById('loadingB').classList.add('hidden');

                if (task.state === TaskState.COMPLETED) {
                    const rateData = task.result;
                    ratingsB = rateData.ratings;
                    recommendationsB = rateData.recommendations;
                    referenceDefinitionsB = rateData.reference_definitions || {};
                    currentDimensionsB = dimensions;
                    displayRatingsB(rateData, referenceDefinitionsB);

                    if (rateData.token_usage) {
                        displayTokenUsageB(rateData.token_usage);
                    }

                    document.getElementById('ratingsSectionB').classList.remove('hidden');
                } else {
                    document.getElementById('uploadSectionB').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loadingB').classList.add('hidden');
                document.getElementById('uploadSectionB').classList.remove('hidden');
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function displayTokenUsageB(tokenUsage) {
            document.getElementById('promptTokensB').textContent = tokenUsage.prompt_tokens.toLocaleString();
            document.getElementById('completionTokensB').textContent = tokenUsage.completion_tokens.toLocaleString();
            document.getElementById('totalTokensB').textContent = tokenUsage.total_tokens.toLocaleString();
            document.getElementById('apiCallsB').textContent = tokenUsage.api_calls || 0;
        }

        let referenceDefinitionsB = {};  // Store reference definitions for Mode B

        function displayRatingsB(data, definitions = {}) {
            document.getElementById('correctCountB').textContent = data.summary.correct;
            document.getElementById('partialCountB').textContent = data.summary.partially_correct;
            document.getElementById('incorrectCountB').textContent = data.summary.incorrect;
            document.getElementById('needsReviewCountB').textContent = recommendationsB.length;

            referenceDefinitionsB = definitions;

            const tbody = document.getElementById('ratingsBodyB');
            const thead = document.querySelector('#ratingsSectionB thead tr');
            tbody.innerHTML = '';

            // V2.1: Check if multi-dimension mode (has dimensions array)
            const isMultiDim = data.dimensions && data.dimensions.length > 1;
            const dimensions = data.dimensions || currentDimensionsB || [];

            const dimensionLabels = {
                'competency': 'Comp',
                'objective': 'Obj',
                'skill': 'Skill',
                'nmc_competency': 'NMC',
                'area_topics': 'Topic',
                'blooms': 'Blooms',
                'complexity': 'Cmplx'
            };

            // V2.1: Update table headers for multi-dimension mode
            if (isMultiDim) {
                let headerHtml = `
                    <th style="width: 40px;"><input type="checkbox" class="checkbox" id="selectAllCheckboxB" onchange="toggleSelectAllB()"></th>
                    <th style="width: 60px;">Q#</th>
                    <th style="width: 250px;">Question</th>
                `;
                dimensions.forEach(dim => {
                    headerHtml += `<th style="width: 120px;">${dimensionLabels[dim] || dim}<br><small>Curr  Sugg</small></th>`;
                });
                headerHtml += `
                    <th style="width: 80px;">Rating</th>
                    <th style="width: 70px;">Conf</th>
                    <th>Justification</th>
                `;
                thead.innerHTML = headerHtml;
            }

            recommendationsB.forEach((rec, index) => {
                const row = document.createElement('tr');
                let ratingClass = 'rating-incorrect';
                const overallRating = rec.rating || rec.overall_rating || 'unknown';
                if (overallRating === 'correct') ratingClass = 'rating-correct';
                else if (overallRating === 'partially_correct') ratingClass = 'rating-partial';

                // V2.1: Multi-dimension display
                if (isMultiDim && rec.dimension_ratings) {
                    let rowHtml = `
                        <td><input type="checkbox" class="checkbox" data-index="${index}" onchange="updateSelectionB()"></td>
                        <td>${rec.question_num}</td>
                        <td class="question-text">
                            <div class="question-text-full">${rec.question_text || ''}</div>
                        </td>
                    `;

                    dimensions.forEach(dim => {
                        const dimRating = rec.dimension_ratings[dim] || {};
                        const current = dimRating.current || rec.current_mapping?.[`mapped_${dim}`] || '-';
                        const suggested = dimRating.suggested || current;
                        const dimRatingVal = dimRating.rating || 'unknown';

                        let dimClass = '';
                        if (dimRatingVal === 'correct') dimClass = 'color: #065f46;';
                        else if (dimRatingVal === 'incorrect') dimClass = 'color: #991b1b; font-weight: bold;';
                        else if (dimRatingVal === 'partially_correct') dimClass = 'color: #92400e;';

                        if (dimRatingVal === 'correct') {
                            rowHtml += `<td style="${dimClass}"><strong>${current}</strong></td>`;
                        } else {
                            rowHtml += `<td style="${dimClass}"><span style="text-decoration: line-through;">${current}</span>  <strong>${suggested}</strong></td>`;
                        }
                    });

                    const confidence = rec.confidence || 0;
                    let confClass = 'confidence-low';
                    if (confidence >= 0.85) confClass = 'confidence-high';
                    else if (confidence >= 0.70) confClass = 'confidence-medium';

                    rowHtml += `
                        <td><span class="rating-badge ${ratingClass}">${overallRating.replace('_', ' ')}</span></td>
                        <td><span class="confidence-badge ${confClass}">${Math.round(confidence * 100)}%</span></td>
                        <td class="justification">${rec.justification || ''}</td>
                    `;
                    row.innerHTML = rowHtml;
                } else {
                    // Single dimension mode - original display
                    let originalCode = 'N/A';
                    if (rec.current_mapping) {
                        if (rec.current_mapping.id) {
                            originalCode = rec.current_mapping.id;
                        } else if (rec.current_mapping.topic) {
                            originalCode = rec.current_mapping.topic;
                            if (rec.current_mapping.subtopic) {
                                originalCode += ' / ' + rec.current_mapping.subtopic;
                            }
                        } else {
                            // Try to get any mapped_* value
                            const mappedKeys = Object.keys(rec.current_mapping).filter(k => k.startsWith('mapped_'));
                            if (mappedKeys.length > 0) {
                                originalCode = rec.current_mapping[mappedKeys[0]] || 'N/A';
                            }
                        }
                    }

                    const suggestedCode = rec.mapped_id || rec.mapped_topic || rec.recommended_mapping || '';
                    const definition = definitions[suggestedCode] || definitions[rec.mapped_id] || definitions[rec.mapped_topic] || '';

                    const confidence = rec.confidence || 0;
                    let confClass = 'confidence-low';
                    if (confidence >= 0.85) confClass = 'confidence-high';
                    else if (confidence >= 0.70) confClass = 'confidence-medium';

                    row.innerHTML = `
                        <td><input type="checkbox" class="checkbox" data-index="${index}" onchange="updateSelectionB()"></td>
                        <td>${rec.question_num}</td>
                        <td class="question-text">
                            <div class="question-text-full">${rec.question_text || ''}</div>
                        </td>
                        <td><strong>${originalCode}</strong></td>
                        <td><span class="rating-badge ${ratingClass}">${overallRating.replace('_', ' ')}</span></td>
                        <td><strong>${suggestedCode}</strong></td>
                        <td class="definition-text">${definition}</td>
                        <td><span class="confidence-badge ${confClass}">${Math.round(confidence * 100)}%</span></td>
                        <td class="justification">${rec.justification || rec.suggestion_justification || ''}</td>
                    `;
                }
                tbody.appendChild(row);
            });
        }

        function updateSelectionB() {
            const checkboxes = document.querySelectorAll('#ratingsBodyB input[type="checkbox"]');
            selectedIndicesB = [];
            checkboxes.forEach(cb => { if (cb.checked) selectedIndicesB.push(parseInt(cb.dataset.index)); });
            document.getElementById('selectionCountB').textContent = selectedIndicesB.length;
        }

        function toggleSelectAllB() {
            const selectAll = document.getElementById('selectAllCheckboxB').checked;
            document.querySelectorAll('#ratingsBodyB input[type="checkbox"]').forEach(cb => cb.checked = selectAll);
            updateSelectionB();
        }

        function selectAllIncorrectB() {
            document.querySelectorAll('#ratingsBodyB input[type="checkbox"]').forEach((cb, i) => {
                cb.checked = recommendationsB[i].rating === 'incorrect';
            });
            updateSelectionB();
        }

        function selectNoneB() {
            document.querySelectorAll('#ratingsBodyB input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckboxB').checked = false;
            updateSelectionB();
        }

        function saveAndDownloadB() {
            if (selectedIndicesB.length === 0) {
                showStatus('Please select at least one correction', 'error');
                return;
            }
            openSaveModal(recommendationsB, 'B', uploadedFilesB.mappedFile);
        }

        function startOverB() {
            // V2: Reset within mode - clears form and results, stays in Mode B
            ratingsB = [];
            recommendationsB = [];
            selectedIndicesB = [];
            uploadedFilesB = { mappedFile: null, referenceFile: null };
            document.getElementById('mappedFileB').value = '';
            document.getElementById('referenceFileB').value = '';
            document.getElementById('ratingsSectionB').classList.add('hidden');
            document.getElementById('loadingB').classList.add('hidden');
            document.getElementById('uploadSectionB').classList.remove('hidden');
            document.getElementById('selectionCountB').textContent = '0';
            document.getElementById('ratingsBodyB').innerHTML = '';
            document.getElementById('selectAllCheckboxB').checked = false;
        }

        // ==================== MODE C FUNCTIONS ====================
        async function generateInsightsC() {
            const mappedFile = document.getElementById('mappedFileC').files[0];

            if (!mappedFile) {
                showStatus('Please select a mapped file', 'error');
                return;
            }

            // Get selected dimensions (empty array means auto-detect)
            const selectedDimensions = getSelectedDimensions('dimensionsC');

            const formData = new FormData();
            formData.append('mapped_file', mappedFile);

            const referenceFile = document.getElementById('referenceFileC').files[0];
            if (referenceFile) {
                formData.append('reference_file', referenceFile);
            }

            try {
                // First upload the files
                const uploadResponse = await fetch(`${API_URL}/upload-mapped`, { method: 'POST', body: formData });
                const uploadData = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    showStatus(`Error: ${uploadData.error}`, 'error');
                    return;
                }

                uploadedFilesC.mappedFile = uploadData.mapped_file;
                uploadedFilesC.referenceFile = uploadData.reference_file;

                // Create task description
                const dimDesc = selectedDimensions.length > 0
                    ? selectedDimensions.map(d => d.replace('_', ' ')).join(', ')
                    : 'auto-detect';
                const taskId = taskManager.create('mode_c', `Generating insights (${dimDesc}) from ${mappedFile.name}`);

                document.getElementById('uploadSectionC').classList.add('hidden');
                document.getElementById('loadingC').classList.remove('hidden');

                // Run async with task tracking
                const task = await taskManager.run(taskId, async (updateProgress) => {
                    const response = await fetch(`${API_URL}/generate-insights`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            mapped_file: uploadedFilesC.mappedFile,
                            reference_file: uploadedFilesC.referenceFile,
                            dimensions: selectedDimensions
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Insights generation failed');
                    }

                    return await response.json();
                });

                document.getElementById('loadingC').classList.add('hidden');

                if (task.state === TaskState.COMPLETED) {
                    displayInsightsC(task.result);
                    document.getElementById('insightsSectionC').classList.remove('hidden');
                } else {
                    document.getElementById('uploadSectionC').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loadingC').classList.add('hidden');
                document.getElementById('uploadSectionC').classList.remove('hidden');
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function displayInsightsC(data) {
            // Summary stats (kept minimal since executive_summary chart has details)
            const statsDiv = document.getElementById('summaryStatsC');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.summary.total_questions}</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.summary.topics_covered}</div>
                    <div class="stat-label">Items Covered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(data.summary.average_confidence * 100)}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(data.detected_dimensions || []).length}</div>
                    <div class="stat-label">Dimensions Analyzed</div>
                </div>
            `;

            // Charts - New infographic style with dimension separation
            const chartsDiv = document.getElementById('chartsGridC');
            chartsDiv.innerHTML = '';

            // Display detected dimensions
            const detectedDims = data.detected_dimensions || [];
            if (detectedDims.length > 0) {
                const dimBadges = document.createElement('div');
                dimBadges.className = 'dimension-badges';
                dimBadges.style.cssText = 'margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;';
                dimBadges.innerHTML = `
                    <span style="color: #64748b; font-size: 14px; margin-right: 5px;">Dimensions:</span>
                    ${detectedDims.map(d => `<span style="background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 500;">${formatDimensionName(d)}</span>`).join('')}
                `;
                chartsDiv.appendChild(dimBadges);
            }

            // Executive Summary and Confidence Gauge (global charts)
            const globalCharts = [
                { key: 'executive_summary', fullWidth: true, label: 'Executive Summary' },
                { key: 'confidence_gauge', fullWidth: false, label: 'Overall Confidence' }
            ];

            globalCharts.forEach(chart => {
                if (data.charts[chart.key]) {
                    const container = document.createElement('div');
                    container.className = chart.fullWidth ? 'chart-container full-width' : 'chart-container';
                    container.innerHTML = `<img src="${BASE_URL}${data.charts[chart.key]}" alt="${chart.label}">`;
                    chartsDiv.appendChild(container);
                }
            });

            // Per-dimension charts (coverage heatmap and gap analysis)
            detectedDims.forEach(dim => {
                const dimLabel = formatDimensionName(dim);

                // Section header for this dimension
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'dimension-section-header';
                sectionHeader.style.cssText = 'width: 100%; margin: 25px 0 15px 0; padding: 12px 20px; background: linear-gradient(135deg, #1e293b, #334155); color: white; border-radius: 8px; font-weight: 600; font-size: 16px;';
                sectionHeader.textContent = `${dimLabel} Analysis`;
                chartsDiv.appendChild(sectionHeader);

                // Coverage heatmap for this dimension
                const heatmapKey = `coverage_heatmap_${dim}`;
                if (data.charts[heatmapKey]) {
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    container.innerHTML = `<img src="${BASE_URL}${data.charts[heatmapKey]}" alt="${dimLabel} Coverage">`;
                    chartsDiv.appendChild(container);
                }

                // Gap analysis for this dimension
                const gapKey = `gap_analysis_${dim}`;
                if (data.charts[gapKey]) {
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    container.innerHTML = `<img src="${BASE_URL}${data.charts[gapKey]}" alt="${dimLabel} Gap Analysis">`;
                    chartsDiv.appendChild(container);
                }
            });

            // Coverage Tables - one per dimension
            const coverageTables = data.coverage_tables || {};
            const tableSection = document.getElementById('coverageTableSectionC');
            const tableBody = document.getElementById('coverageTableBodyC');

            // Clear existing content
            tableBody.innerHTML = '';

            // If we have per-dimension tables, show them with headers
            if (Object.keys(coverageTables).length > 0) {
                Object.entries(coverageTables).forEach(([dim, tableData]) => {
                    if (tableData && tableData.length > 0) {
                        // Dimension header row
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'dimension-table-header';
                        headerRow.innerHTML = `<td colspan="4" style="background: #1e293b; color: white; font-weight: 600; padding: 12px 16px;">${formatDimensionName(dim)}</td>`;
                        tableBody.appendChild(headerRow);

                        // Data rows for this dimension
                        tableData.forEach(item => {
                            const row = document.createElement('tr');
                            let rowClass = '';
                            if (item.count === 0) rowClass = 'gap-row';
                            else if (item.count <= 2) rowClass = 'low-row';
                            row.className = rowClass;

                            let barClass = 'high';
                            if (item.percentage < 5) barClass = 'low';
                            else if (item.percentage < 15) barClass = 'medium';
                            const barWidth = Math.min(item.percentage * 2, 60);

                            row.innerHTML = `
                                <td class="code-cell">${item.code}</td>
                                <td class="definition-cell">${item.definition || '-'}</td>
                                <td class="count-cell">${item.count}</td>
                                <td class="percentage-cell">
                                    ${item.percentage}%
                                    <span class="percentage-bar ${barClass}" style="width: ${barWidth}px;"></span>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                });
                tableSection.classList.remove('hidden');
            } else if (data.coverage_table && data.coverage_table.length > 0) {
                // Fallback to single coverage table (backward compatibility)
                data.coverage_table.forEach(item => {
                    const row = document.createElement('tr');
                    let rowClass = '';
                    if (item.count === 0) rowClass = 'gap-row';
                    else if (item.count <= 2) rowClass = 'low-row';
                    row.className = rowClass;

                    let barClass = 'high';
                    if (item.percentage < 5) barClass = 'low';
                    else if (item.percentage < 15) barClass = 'medium';
                    const barWidth = Math.min(item.percentage * 2, 60);

                    row.innerHTML = `
                        <td class="code-cell">${item.code}</td>
                        <td class="definition-cell">${item.definition || '-'}</td>
                        <td class="count-cell">${item.count}</td>
                        <td class="percentage-cell">
                            ${item.percentage}%
                            <span class="percentage-bar ${barClass}" style="width: ${barWidth}px;"></span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                tableSection.classList.remove('hidden');
            } else {
                tableSection.classList.add('hidden');
            }
        }

        // Helper to format dimension names for display
        function formatDimensionName(dim) {
            const names = {
                'competency': 'Competency',
                'objective': 'Objective',
                'skill': 'Skill',
                'nmc_competency': 'NMC Competency',
                'area_topics': 'Topic Areas',
                'blooms': 'Blooms Level',
                'complexity': 'Complexity'
            };
            return names[dim] || dim.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function startOverC() {
            // V2: Reset within mode - clears form and results, stays in Mode C
            uploadedFilesC = { mappedFile: null, referenceFile: null };
            document.getElementById('mappedFileC').value = '';
            document.getElementById('referenceFileC').value = '';
            document.getElementById('insightsSectionC').classList.add('hidden');
            document.getElementById('loadingC').classList.add('hidden');
            document.getElementById('uploadSectionC').classList.remove('hidden');
            document.getElementById('summaryStatsC').innerHTML = '';
            document.getElementById('chartsGridC').innerHTML = '';
            document.getElementById('coverageTableBodyC').innerHTML = '';
            // Clear dimension checkboxes
            document.querySelectorAll('#dimensionsC input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
    </script>
</body>
</html>
